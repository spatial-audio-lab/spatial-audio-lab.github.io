<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Harmonic Layers - 3D Spatial Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=JetBrains+Mono&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Outfit", sans-serif;
        background: #080a0f;
        color: #e2e8f0;
        overflow: hidden;
        height: 100vh;
      }
      .glass {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .indicator-glow {
        box-shadow: 0 0 15px rgba(52, 211, 153, 0.5);
      }
      input[type="range"] {
        @apply h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-emerald-500;
      }
      select {
        @apply bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm focus:ring-2 focus:ring-emerald-500 outline-none;
      }

      /* Custom scrollbar dla panelu kontrolnego */
      .custom-scroll::-webkit-scrollbar {
        width: 4px;
      }
      .custom-scroll::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scroll::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
      }
    </style>
  </head>
  <body class="flex flex-col items-center justify-center p-4 md:p-8">
    <!-- Start Overlay -->
    <div
      id="startOverlay"
      class="fixed inset-0 z-50 flex items-center justify-center bg-[#080a0f]"
    >
      <div class="text-center p-8 glass rounded-[40px] max-w-md">
        <h1
          class="text-5xl font-bold mb-4 bg-gradient-to-br from-emerald-400 to-cyan-400 bg-clip-text text-transparent"
        >
          Sekwencer 3D
        </h1>
        <p class="text-slate-400 mb-8 leading-relaxed">
          System projektowania trajektorii dźwięku HRTF w czasie rzeczywistym.
        </p>
        <button
          id="btnStart"
          class="w-full py-4 bg-emerald-500 hover:bg-emerald-400 text-black font-bold rounded-2xl transition-all transform hover:scale-105 active:scale-95"
        >
          Uruchom System
        </button>
      </div>
    </div>

    <div
      class="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-12 gap-8 h-full max-h-[850px]"
    >
      <!-- Lewy Panel: Kontrola Trajektorii i Parametrów -->
      <div
        class="lg:col-span-4 flex flex-col gap-6 overflow-y-auto pr-2 custom-scroll"
      >
        <!-- Sekcja: Geometria -->
        <div class="glass p-8 rounded-[32px] flex flex-col gap-6">
          <div class="flex items-center justify-between">
            <h2
              class="text-sm font-bold text-emerald-400 uppercase tracking-widest"
            >
              Geometria Ruchu
            </h2>
            <div
              id="audioIndicator"
              class="w-2.5 h-2.5 rounded-full bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,0.5)]"
            ></div>
          </div>

          <div class="space-y-5">
            <div>
              <label
                class="text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-2 block"
                >Kształt Trajektorii</label
              >
              <select id="shapeSelect" class="w-full">
                <option value="circle">Okrąg (Płaszczyzna XZ)</option>
                <option value="square">Kwadrat (Liniowy)</option>
                <option value="lissajous">Węzeł Lissajous</option>
                <option value="eight">Lemniskata (Nieskończoność)</option>
                <option value="helix">Helix (Spirala 3D)</option>
              </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  class="text-[10px] text-slate-500 uppercase font-bold mb-2 block"
                  >Prędkość</label
                >
                <input
                  type="range"
                  id="speedRange"
                  min="0.1"
                  max="4"
                  step="0.1"
                  value="1"
                  class="w-full"
                />
              </div>
              <div>
                <label
                  class="text-[10px] text-slate-500 uppercase font-bold mb-2 block"
                  >Kierunek</label
                >
                <button
                  id="btnDirection"
                  class="w-full py-2 bg-slate-800 rounded-xl text-[10px] font-bold uppercase tracking-wider hover:bg-slate-700 transition-colors"
                >
                  Zgodnie z wkaz.
                </button>
              </div>
            </div>

            <div>
              <label
                class="text-[10px] text-slate-500 uppercase font-bold mb-2 block"
                >Skala (Rozmiar: <span id="sizeVal">25</span>m)</label
              >
              <input
                type="range"
                id="sizeRange"
                min="5"
                max="55"
                step="1"
                value="25"
                class="w-full"
              />
            </div>
          </div>
        </div>

        <!-- Sekcja: Orientacja i Barwa -->
        <div class="glass p-8 rounded-[32px] flex flex-col gap-6">
          <h2 class="text-sm font-bold text-cyan-400 uppercase tracking-widest">
            Przestrzeń i Barwa
          </h2>

          <div class="space-y-5">
            <div>
              <label
                class="text-[10px] text-slate-500 uppercase font-bold mb-2 block"
                >Pochylenie (X / Pitch: <span id="rotXVal">0</span>°)</label
              >
              <input
                type="range"
                id="rotXRange"
                min="0"
                max="360"
                value="0"
                class="w-full"
              />
            </div>
            <div>
              <label
                class="text-[10px] text-slate-500 uppercase font-bold mb-2 block"
                >Obrót (Y / Yaw: <span id="rotYVal">0</span>°)</label
              >
              <input
                type="range"
                id="rotYRange"
                min="0"
                max="360"
                value="0"
                class="w-full"
              />
            </div>
            <div>
              <label
                class="text-[10px] text-slate-500 uppercase font-bold mb-2 block"
                >Kształt fali (Timbre)</label
              >
              <select id="waveformSelect" class="w-full">
                <option value="sine">Sinusoidalna (Łagodna)</option>
                <option value="triangle" selected>
                  Trójkątna (Zbalansowana)
                </option>
                <option value="sawtooth">Piłokształtna (Ostra)</option>
                <option value="square">Prostokątna (Cyfrowa)</option>
              </select>
            </div>
            <button
              id="btnToggleAudio"
              class="w-full py-4 bg-emerald-500/10 border border-emerald-500/50 text-emerald-400 rounded-2xl hover:bg-emerald-500/20 transition-all font-bold uppercase tracking-widest text-xs"
            >
              ODTWÓRZ / WYCISZ
            </button>
          </div>
        </div>
      </div>

      <!-- Główny Widok: Radar i Oś Pionowa -->
      <div
        class="lg:col-span-8 glass rounded-[40px] relative p-12 flex flex-col items-center justify-center"
      >
        <div
          class="relative w-full h-full flex items-center justify-center gap-12"
        >
          <!-- Radar (X/Z) -->
          <div class="relative">
            <canvas
              id="radarCanvas"
              class="max-w-full aspect-square bg-[#020617]/50 rounded-full border border-white/5 shadow-2xl"
            ></canvas>

            <!-- Etykiety kierunków (Zgodne z Web Audio) -->
            <div
              class="absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] text-slate-600 font-bold uppercase tracking-[0.3em]"
            >
              Przód (-Z)
            </div>
            <div
              class="absolute -bottom-6 left-1/2 -translate-x-1/2 text-[10px] text-slate-600 font-bold uppercase tracking-[0.3em]"
            >
              Tył (+Z)
            </div>
            <div
              class="absolute -left-12 top-1/2 -translate-y-1/2 text-[10px] text-slate-600 font-bold uppercase tracking-[0.3em] rotate-90"
            >
              Lewo (-X)
            </div>
            <div
              class="absolute -right-12 top-1/2 -translate-y-1/2 text-[10px] text-slate-600 font-bold uppercase tracking-[0.3em] -rotate-90"
            >
              Prawo (+X)
            </div>
          </div>

          <!-- Oś Pionowa (Y) -->
          <div class="flex flex-col items-center h-[70%] w-20">
            <div
              class="text-[10px] text-slate-600 font-bold mb-4 uppercase tracking-widest"
            >
              Wysokość
            </div>
            <div
              class="relative flex-1 w-3 bg-slate-900 rounded-full border border-white/5 overflow-hidden"
            >
              <!-- Środek (0) -->
              <div
                class="absolute top-1/2 left-0 w-full h-[1px] bg-white/10"
              ></div>
              <!-- Wskaźnik wysokości -->
              <div
                id="elevationIndicator"
                class="absolute left-1/2 -translate-x-1/2 w-6 h-6 bg-emerald-400 rounded-full indicator-glow transition-all duration-75 border-4 border-slate-900"
                style="bottom: 50%"
              ></div>
            </div>
            <div
              id="heightLabel"
              class="text-xs font-mono mt-4 text-emerald-400 font-bold"
            >
              0.0m
            </div>
          </div>
        </div>

        <!-- Debug Info / Coordinates -->
        <div
          class="absolute bottom-10 left-12 font-mono text-[10px] text-slate-500 space-y-2 bg-black/30 p-4 rounded-2xl border border-white/5"
        >
          <div id="debugCoords" class="text-emerald-300">
            XYZ: [0.00, 0.00, 0.00]
          </div>
          <div class="flex items-center gap-2">
            <span
              class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"
            ></span>
            <span>ENGINE: WEB_AUDIO_HRTF_V2</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      const state = {
        ctx: null,
        panner: null,
        osc: null,
        gain: null,
        isRunning: false,
        audioActive: false,

        shape: "circle",
        speed: 1.0,
        direction: 1,
        size: 25,
        rotX: 0,
        rotY: 0,
        waveform: "triangle",

        time: 0,
        pos: { x: 0, y: 0, z: 0 },

        canvas: null,
        canvasCtx: null,
      }

      // --- MATEMATYKA TRANSFORMACJI ---
      const Math3D = {
        rotateX(p, angle) {
          const rad = (angle * Math.PI) / 180
          const cos = Math.cos(rad)
          const sin = Math.sin(rad)
          return { x: p.x, y: p.y * cos - p.z * sin, z: p.y * sin + p.z * cos }
        },
        rotateY(p, angle) {
          const rad = (angle * Math.PI) / 180
          const cos = Math.cos(rad)
          const sin = Math.sin(rad)
          return { x: p.x * cos + p.z * sin, y: p.y, z: -p.x * sin + p.z * cos }
        },
      }

      const Trajectories = {
        circle: (t) => ({ x: Math.cos(t), y: 0, z: Math.sin(t) }),
        square: (t) => {
          const cycle = (t % (Math.PI * 2)) / (Math.PI * 2)
          const progress = cycle * 4
          const side = Math.floor(progress)
          const lt = progress - side
          if (side === 0) return { x: -1 + lt * 2, y: 0, z: -1 }
          if (side === 1) return { x: 1, y: 0, z: -1 + lt * 2 }
          if (side === 2) return { x: 1 - lt * 2, y: 0, z: 1 }
          return { x: -1, y: 0, z: 1 - lt * 2 }
        },
        lissajous: (t) => ({
          x: Math.sin(3 * t),
          y: Math.sin(t),
          z: Math.sin(2 * t + Math.PI / 4),
        }),
        eight: (t) => {
          const d = 1 + Math.sin(t) ** 2
          return {
            x: Math.cos(t) / d,
            y: 0,
            z: (Math.sin(t) * Math.cos(t)) / d,
          }
        },
        helix: (t) => ({
          x: Math.cos(t),
          y: Math.sin(t * 0.4),
          z: Math.sin(t),
        }),
      }

      // --- SILNIK AUDIO ---
      async function initAudio() {
        if (state.ctx) return
        state.ctx = new (window.AudioContext || window.webkitAudioContext)()

        state.panner = new PannerNode(state.ctx, {
          panningModel: "HRTF",
          distanceModel: "inverse",
        })

        state.gain = state.ctx.createGain()
        state.gain.gain.value = 0

        state.osc = state.ctx.createOscillator()
        state.osc.type = state.waveform
        state.osc.frequency.value = 140

        const filter = state.ctx.createBiquadFilter()
        filter.type = "lowpass"
        filter.frequency.value = 1000

        state.osc
          .connect(filter)
          .connect(state.panner)
          .connect(state.gain)
          .connect(state.ctx.destination)
        state.osc.start()

        // Standard: Patrzymy w -Z, Góra to +Y
        state.ctx.listener.setOrientation(0, 0, -1, 0, 1, 0)
      }

      // --- PĘTLA GŁÓWNA ---
      function update() {
        if (state.isRunning) {
          state.time += 0.016 * state.speed * state.direction

          let point = Trajectories[state.shape](state.time)
          point.x *= state.size
          point.y *= state.size
          point.z *= state.size

          point = Math3D.rotateX(point, state.rotX)
          point = Math3D.rotateY(point, state.rotY)

          state.pos = point

          const now = state.ctx.currentTime
          state.panner.positionX.setTargetAtTime(point.x, now, 0.05)
          state.panner.positionY.setTargetAtTime(point.y, now, 0.05)
          state.panner.positionZ.setTargetAtTime(point.z, now, 0.05)

          draw()
          syncUI()
        }
        requestAnimationFrame(update)
      }

      // --- RYSOWANIE ---
      function draw() {
        const ctx = state.canvasCtx
        const w = state.canvas.width
        const h = state.canvas.height
        const cx = w / 2
        const cy = h / 2
        const zoom = w / 2 / 60

        ctx.clearRect(0, 0, w, h)

        // Siatka radaru
        ctx.strokeStyle = "rgba(255, 255, 255, 0.03)"
        ctx.lineWidth = 1
        for (let r = 20; r <= 60; r += 20) {
          ctx.beginPath()
          ctx.arc(cx, cy, r * zoom, 0, Math.PI * 2)
          ctx.stroke()
        }

        // Podgląd trajektorii (Ghost Path)
        ctx.beginPath()
        ctx.strokeStyle = "rgba(16, 185, 129, 0.1)"
        ctx.setLineDash([5, 5])
        for (let i = 0; i < Math.PI * 2; i += 0.1) {
          let p = Trajectories[state.shape](i)
          p.x *= state.size
          p.y *= state.size
          p.z *= state.size
          p = Math3D.rotateX(p, state.rotX)
          p = Math3D.rotateY(p, state.rotY)
          const px = cx + p.x * zoom
          const pz = cy + p.z * zoom
          if (i === 0) ctx.moveTo(px, pz)
          else ctx.lineTo(px, pz)
        }
        ctx.stroke()
        ctx.setLineDash([])

        // Punkt dźwięku
        const tx = cx + state.pos.x * zoom
        const tz = cy + state.pos.z * zoom

        ctx.shadowBlur = 20
        ctx.shadowColor = "#10b981"
        ctx.fillStyle = "#10b981"
        ctx.beginPath()
        ctx.arc(tx, tz, 7, 0, Math.PI * 2)
        ctx.fill()
        ctx.shadowBlur = 0

        // Wskaźnik wysokości (Y) - mapowanie -60m do 60m na 0-100%
        const elevIndicator = document.getElementById("elevationIndicator")
        const percent = ((state.pos.y + 60) / 120) * 100
        elevIndicator.style.bottom = `${Math.max(0, Math.min(100, percent))}%`
        document.getElementById("heightLabel").textContent =
          `${state.pos.y.toFixed(1)}m`
      }

      function syncUI() {
        document.getElementById("sizeVal").textContent = state.size
        document.getElementById("rotXVal").textContent = state.rotX
        document.getElementById("rotYVal").textContent = state.rotY
        document.getElementById("debugCoords").textContent =
          `XYZ: [${state.pos.x.toFixed(2)}, ${state.pos.y.toFixed(2)}, ${state.pos.z.toFixed(2)}]`
      }

      // --- EVENTY ---
      document.getElementById("btnStart").onclick = async () => {
        await initAudio()
        state.isRunning = true
        document.getElementById("startOverlay").style.display = "none"
        state.canvas = document.getElementById("radarCanvas")
        state.canvasCtx = state.canvas.getContext("2d")
        state.canvas.width = 500
        state.canvas.height = 500
        update()
      }

      document.getElementById("btnToggleAudio").onclick = () => {
        state.audioActive = !state.audioActive
        const val = state.audioActive ? 0.35 : 0
        state.gain.gain.setTargetAtTime(val, state.ctx.currentTime, 0.1)
        document.getElementById("audioIndicator").className =
          `w-2.5 h-2.5 rounded-full ${state.audioActive ? "bg-emerald-500 shadow-[0_0_10px_rgba(52,211,153,0.5)]" : "bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,0.5)]"}`
      }

      document.getElementById("btnDirection").onclick = (e) => {
        state.direction *= -1
        e.target.textContent =
          state.direction === 1 ? "Zgodnie z wskaz." : "Przeciwnie"
      }

      document.getElementById("shapeSelect").onchange = (e) =>
        (state.shape = e.target.value)
      document.getElementById("waveformSelect").onchange = (e) => {
        state.waveform = e.target.value
        if (state.osc) state.osc.type = state.waveform
      }
      document.getElementById("speedRange").oninput = (e) =>
        (state.speed = parseFloat(e.target.value))
      document.getElementById("sizeRange").oninput = (e) =>
        (state.size = parseInt(e.target.value))
      document.getElementById("rotXRange").oninput = (e) =>
        (state.rotX = parseInt(e.target.value))
      document.getElementById("rotYRange").oninput = (e) =>
        (state.rotY = parseInt(e.target.value))
    </script>
  </body>
</html>
